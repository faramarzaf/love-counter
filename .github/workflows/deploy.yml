name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main # Trigger the workflow on pushes to the main branch
  workflow_dispatch: # Allows you to run this workflow manually from the Actions tab

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    # --- ADD THIS PERMISSIONS BLOCK ---
    # This gives the workflow the necessary permissions to push to the gh-pages branch.
    permissions:
      contents: write
    # ------------------------------------

    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build and export to directory
        uses: docker/build-push-action@v4
        with:
          context: .
          load: true # Load the image into the local Docker daemon
          tags: love-app:latest # Tag the image for reference

          build-args: |
            REACT_APP_API_KEY=${{ secrets.REACT_APP_API_KEY }}
            REACT_APP_AUTH_DOMAIN=${{ secrets.REACT_APP_AUTH_DOMAIN }}
            REACT_APP_DATABASE_URL=${{ secrets.REACT_APP_DATABASE_URL }}
            REACT_APP_PROJECT_ID=${{ secrets.REACT_APP_PROJECT_ID }}
            REACT_APP_STORAGE_BUCKET=${{ secrets.REACT_APP_STORAGE_BUCKET }}
            REACT_APP_MESSAGING_SENDER_ID=${{ secrets.REACT_APP_MESSAGING_SENDER_ID }}
            REACT_APP_APP_ID=${{ secrets.REACT_APP_APP_ID }}
            REACT_APP_MY_EMAIL=${{ secrets.REACT_APP_MY_EMAIL }}
            REACT_APP_HER_EMAIL=${{ secrets.REACT_APP_HER_EMAIL }}
            REACT_APP_MEASUREMENT_ID="${{ secrets.REACT_APP_MEASUREMENT_ID }}

      - name: Create build directory
        run: mkdir -p build_output

      - name: Copy static files from Docker image
        run: |
          docker create --name temp_container love-app:latest
          docker cp temp_container:/usr/share/nginx/html/. ./build_output
          docker rm temp_container

      - name: Deploy to GitHub Pages üöÄ
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages # The branch the action should deploy to
          folder: build_output # The folder the action should deploy